\section{Аналитическая часть}

\subsection{Постановка задачи}
Результатом работы должна стать программа для загрузки файлов по протоколу Bittorrent, удовлетворяющая следующим требованиям:
\begin{itemize}
	\item поддерживать файлы расширения torrent;
	
	\item поддерживать функцию загрузки данных как от сервера, так и от других клиентов;
	
	\item обладать графическим интерфейсом для удобства выполнения действий и просмотра текущей информации по состоянию загрузки.
	
\end{itemize}

Первостепенной задачей для дальнейшей разработки является изучения устройства выбранного протокола. \newline

\subsection{Принцип работы протокола}
Bittorrent -- P2P протокол для кооперативного обмена файлами через интернет. 

В данном протоколе выделены две роли:
\begin{enumerate}
	\item \textbf{пир} (клиент) хранит файлы и производит обмен их частями с другими пирами;
	
	\item \textbf{трекер} (сервер) хранит таблицу файлов и список пиров, имеющих данный файл в распоряжении.
\end{enumerate}

Пир, желающий получить файл должен обладать \textbf{.torrent файлом}, с помощью которого он может обратиться к серверу. Сервер предоставляет адреса клиентов, обладающих запрашиваемыми файлами после чего начинается их загрузка. Передача осуществляется частями (\textbf{pieces}), каждый torrent-клиент, скачивая эти части, в то же время отдаёт их другим клиентам, что снижает нагрузку на каждого отдельного клиента. \newline

\subsection{Структура .torrent файла}
Как было отмечено выше, первым шагом в начале загрузки является получение и парсинг файла специального расширения .torrent.

Для кодирования данных в .torrent-файлах используется формат Bencode. Само содержимое -- ассоциативный массив с полями:
\begin{itemize}
	\item \textbf{info} -- вложенный ассоциативный массив который собственно и описывает файлы, которые передаёт торрент;
	
	\item \textbf{announce} -- URL трекера;
	
	\item \textbf{announce-list} -- список трекеров, если их несколько, в Bencode-виде — список списков;
	
	\item \textbf{creation date} -- дата создания;
	
	\item \textbf{comment} -- текстовое описание торрента;
	
	\item \textbf{created by} -- автор торрента. \\
\end{itemize}

info и announce являются обязательными полями, всё остальное — опционально. Первый в свою очередь состоит из:
\begin{itemize}
	\item \textbf{piece length} -- размер одного куска;
	
	\item \textbf{pieces} -- конкатенация SHA1-хешей каждого куска (каждый хэш - 20 символов);
	
	\item \textbf{name} -- имя файла (если файл один);
	
	\item \textbf{length} -- содержит длину файла (если файл один);
	
	\item \textbf{files} -- если файлов несколько, то содержит список ассоциативных массивов (с указанием length и path). \\
\end{itemize}

Данная информация используется на всём протяжении загрузки файла и его последующей раздаче. \newline

\subsection{Взаимодействие клиента и сервера}
Чтобы перейти к загрузке файла клиент должен получить список пиров у трекера. Для этого он должен отправить GET-запрос, называемый анонсом, по адресу announce по пути /announce. После данного действия трекер узнаёт о наличии нового клиента, и может выдать его адрес другим клиентам. Указываются следующие URL-параметры.

\begin{itemize}
	\item \textbf{info\_hash} -- SHA1-хеш словаря info. Используется для поиска файла в таблице трекера, то есть фактически является его уникальным идентификатором.
	
	\item \textbf{peer\_id} -- уникальный ID клиента. Имеет вид \textit{-<2-символьный id><номер версии из 4 цифр>-<12 случайных цифр>}. Такой код может быть сгенерирован клиентом самостоятельно, так как вероятность коллизии с другими клиентами крайне мала (число возможных вариантов peer\_id одной версии превышает количество IPv4 адресов более чем в 200 раз).
	
	\item \textbf{uploaded}, \textbf{downloaded}, \textbf{left} -- количество отправленных, загруженных и незагруженных байтов.
	
	\item \textbf{port} -- TCP-порт, прослушиваемый клиентом. Общепринятыми значениями являются 6881-6889.
	
	\item \textbf{compact} -- принимает ли клиент компактный список пиров. \\
	
\end{itemize}

В случае, если запрос прошёл успешно и по info\_hash был найден необходимый torrent, трекер посылает ответ (также по протоколу HTTP). В его теле содержится следующие поля в формате Bencode:
\begin{itemize}
	\item \textbf{interval} -- интервал в секундах до того, как клиент должен сделать новый запрос к трекеру;
	
	\item \textbf{peers} -- список пиров. В случае, если в запросе compact был равен 1, в ответе будет список будет заменён бинарной строкой, которую потребуется разбить на группы по 6 байт для выделения IPv4 адреса и порта каждого пира. \\
\end{itemize}

Подобные запросы будут повторяться раз в interval секунд для поддержания сервера в курсе актуального состояния загрузки и для получения новых адресов пиров. \newline

\subsection{Структура сообщений}
Протокол BitTorrent определяет следующий способ обмена сообщениями для клиентов, его особенности:
\begin{itemize}
	\item использует стек TCP/IP;
	
	\item файл передаётся по кускам фиксированного размера, не в порядке их следования в файле.
\end{itemize}

Определена следующая структура p2p сообщения:
\begin{enumerate}
	\item \textbf{длина}, Len (4Б) -- размер типа и полезной нагрузки сообщения;
	
	\item \textbf{тип}, ID (1Б) -- определяет вид сообщения и способ его обработки;
	
	\item \textbf{полезная нагрузка}, Payload (0 - 32КБ) - содержит передаваемую информацию.
\end{enumerate}




\subsection{Взаимодействие клиентов}
